// Download worksheet as self-contained HTML report
document.getElementById("downloadBtn").addEventListener("click", () => {
    const table = document.getElementById("worksheetTable");
    if (!table) return;

    const title = document.querySelector("h2").textContent.trim();
    const scopeInfo = document.querySelector(".alert-info");
    const scopeHtml = scopeInfo ? scopeInfo.outerHTML : "";

    // Collect all sections
    let sectionsHtml = "";
    document.querySelectorAll(".card.mb-4").forEach((card) => {
        sectionsHtml += card.outerHTML;
    });

    const html = `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>${title}</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; font-size: 12px; }
h2 { color: #333; }
table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
th, td { border: 1px solid #ccc; padding: 6px 8px; text-align: left; vertical-align: top; }
th { background: #343a40; color: #fff; font-size: 11px; text-transform: uppercase; }
.row-paf { background: #D6EAF8; }
.row-pdlor { background: #FDEBD0; }
.risk-a { background: #28a745 !important; color: #fff; font-weight: bold; text-align: center; }
.risk-b { background: #8bc34a !important; color: #fff; font-weight: bold; text-align: center; }
.risk-c { background: #ffc107 !important; color: #000; font-weight: bold; text-align: center; }
.risk-d { background: #ff9800 !important; color: #fff; font-weight: bold; text-align: center; }
.risk-e { background: #dc3545 !important; color: #fff; font-weight: bold; text-align: center; }
.pec-yes { color: #dc3545; font-weight: bold; }
ul { margin: 0; padding-left: 16px; }
li { margin-bottom: 2px; }
.badge { padding: 2px 6px; border-radius: 4px; font-size: 11px; }
.bg-primary { background: #0d6efd; color: #fff; }
.bg-warning { background: #ffc107; color: #000; }
.alert-info { background: #cfe2ff; border: 1px solid #b6d4fe; padding: 12px; border-radius: 6px; margin-bottom: 16px; }
s { color: #999; }
.card { border: 1px solid #dee2e6; border-radius: 6px; margin-bottom: 16px; }
.card-header { padding: 8px 12px; font-weight: bold; }
.card-body { padding: 12px; }
.text-muted { color: #6c757d; }
@media print { body { margin: 0; } }
</style>
</head>
<body>
<h2>${title}</h2>
${scopeHtml}
${table.outerHTML}
${sectionsHtml}
<p style="color:#999; font-size:10px; margin-top:20px;">Generated by HAZOP P&ID Analysis Tool</p>
</body>
</html>`;

    const blob = new Blob([html], { type: "text/html" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "HAZOP_Worksheet_High_Pressure.html";
    a.click();
    URL.revokeObjectURL(url);
});
